
## 一、准备工作

- 下载百度网盘文件至内网
- 服务器信息
```bash
IP: 172.31.13.20
IP: 172.31.13.21
IP: 172.31.13.22
IP: 172.31.13.23
Pwd: Sasmac@123 或 sasmac@123
```

- 确保服务器`时间`正确（之前错4分钟左右也可）
```bash
# 查看当前系统时间和日期
date

# 查看当前时区设置
timedatectl

# 如果时区不对
sudo timedatectl set-timezone Asia/Shanghai

# 设置为当前的日期和时间（格式：YYYY-MM-DD HH:MM:SS）
sudo date -s "2025-08-14 10:30:00"
```

- 确保本机演示的windows的时间与服务器时间近似同步
- 注意病毒🦠数据（有空格字符）


## 二、停电崩溃的服务重启

- 在每一个节点上20-23执行：
```bash
# 验证 Docker 是否开机自启
sudo systemctl is-enabled docker

# 如果不是，设置自动启动
sudo systemctl enable docker  # 默认通常已启用
```

- 查了一下好像没有，万事大吉😍
```bash
# 此处省略1w字
```



## 三、InDB入库

- 确保各项入库工作暂停⚠️‼️
- 修改所有跟入库程序相关的`dbConfig.json`文件，修改`MYSQL_RESOURCE_DB`对应值为`ard_satellite`
- ⚠️务必确保修改，否则数据可能会错入到非目标数据库中！



## 四、MySQL数据库

- 进入Navicat，找到`172.31.13.21`节点上的mysql，在satellite数据库中导出各个数据表为sql文件
- 新建数据库`ard_satellite`, `ard_dev`, `ard_iam`，字符集选择`utf8mb4`
- 使用sql转换工具（在sql_converter文件夹下），转换sql文件，需要有`python环境`（待转换文件放在`sql`文件夹下，转换后文件访问`fixed`文件夹下）
- 在ard_satellite数据库中依次执行case_table/region_table/sensor_table/product_table/scene_table/image_table对应的转换后的sql文件
- 在ard_dev数据库中依次执行project/project_data对应的sql文件
- 在ard_iam数据库中执行user对应的sql文件
### 改动
#### ard_satellite

- case_table新增字段`user_id`，类型`varchar`，长度`255`，不是null勾选
- case_table `create_time`记得不要⚠️`随当前时间戳更新`（带来相应数据库时区问题）
#### ard_dev

- project表名变更为`project_table`
- project_data表名变更为`project_data_table`
- 依次执行`category_table`和`tool_table`的sql文件（位于百度网盘mysql文件夹下）
#### ard_iam

- user表名变更为`user_table`
- user_table新增字段`avatar_path`，类型varchar，长度255
- user_table将`user_id`设置为主键
- 导入空表`record_table`结构（位于百度网盘mysql文件夹下）



## 五、PostgreSQL数据库

### 1.sql文件拷贝

在`172.31.13.21`节点上，将`satellite_backup.sql`文件（位于pgsql文件夹下）拷贝到`/mnt/volumes/postgresql/data/sql`文件夹下(如果没有sql文件夹，就新建一个)  
### 2、删除或备份旧数据库(在navicat中执行)

#### 方法1 删除旧数据库
也可以先执行第三步，把第三步命令行中的 -d satellite 改为 -d satellite_backup，然后再执行第2步，执行之后把satellite_backup改名为satellite，避免导入出问题，无法恢复数据库。

1.手动删除所有表

2.清理序列序列，执行如下sql语句，直接复制返回的命令并执行，来删除创建的序列，以清理干净模式，并删除模式。

```sql
SELECT 'DROP SEQUENCE IF EXISTS ' || sequence_schema || '.' || sequence_name || ' CASCADE;'
FROM information_schema.sequences
WHERE sequence_schema NOT IN ('pg_catalog', 'information_schema');
```

#### 方法2 重命名旧数据库

- 在Navicat中重命名旧数据库
- 如果出现其他用户session未断开，进入容器内部执行命令：
```bash
docker ps
docker exec <container-name> -it /bin/bash 
```

```sql
psql -U postgres -c "SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE pg_stat_activity.datname = 'satellite';"
```
### 3、恢复

- 进入postgreSQL容器内部命令行界面，执行命令
```bash
docker ps
docker exec <container-name> -it /bin/bash 
```

```bash
psql -U postgres -h 172.31.13.21 -p 5432 -d satellite -f /var/lib/postgresql/data/sql/satellite_backup.sql
```

- 验证新数据库无误后，删除sql文件夹（可选）
```bash
sudo rm -rf /var/lib/postgresql/data/sql/
```



## 六、镜像更新

- 进入`172.31.13.23`节点的`/mnt/images`目录下，备份原有镜像文件，
- 备份后上传新的镜像文件tar包`model-server-arm.tar`（位于images文件夹下），如果有重名就重命名
- 检查运行中的容器，记录容器的名称如model-server、ray-worker_1：
```bash
docker ps
```

- 依次执行（先停止后删除容器）：
```bash
docker stop model-server
docker stop ray-worker_1
docker rm model-server
docker rm ray-worker_1
```

- 如果确定该服务器只有这两个容器，那就直接依次执行以下内容：
```bash
docker stop $(docker ps -q)
docker rm $(docker ps -q)
```

- 检查现有镜像列表及名称：
```bash
docker images
```

- 删除旧的镜像（假设标签是0624）
```bash
docker rmi model-server:0624
```

- 导入新镜像
```bash
docker load -i /mnt/images/model-server-arm.tar
```

- 检查镜像列表
```bash
docker images
```

- 以上同样的步骤，在`172.31.13.20`节点上执行一遍，可能的容器名称是：ray-worker_2和ray-worker_3



## 七、前端更新

- 有两个版本，为了测试分为瓦片红线测试版`dist_test.zip`和生产版本`dist_prod.zip`
- 进入`172.31.13.21`节点的`/mnt/volumes/front/html`文件夹，备份所有文件
- 备份后删除除了`app.conf.json`的其他文件，再把front文件夹下`dist_test.zip`中解压的内容拷贝至其中，观察文件数是否正确，极少数情况会少拷贝（注意`style`）
- 检查`/mnt/volumes/front/html/app.conf.json`和`/mnt/volumes/front/conf/nginx.conf`文件，尤其`websocket`和`back_app3`配置（之前一波应该已经改过）
- 运行命令：
```bash
docker restart front
```

- 可视化功能没问题后，可替换为`dist_prod.zip`中的内容进行部署


## 八、后端更新

- 去掉tile数据源，建议去掉SET SESSION group_concat_max_len = 18446744073709551615（出问题的话就去掉）；useSSL
- 进入`172.31.13.21`节点的`/mnt/volumes/back`文件夹，备份所有文件
- 备份后删除satellite.jar，再把新的`satellite.jar`拷贝进去（在back文件夹下，注意`vmod`配置是否与其他一致⚠️⚠️）
- 同样的文件夹下，确认`band_config.json`是否需要变动
	- 如果添加了新的传感器配置，请确保以下几个位置同时更新：
	- `sensor_table`表新传感器`data_type`同步以及desc
	- 谨慎添加新的data_type，后端要改
- 同样的文件夹下，进入`/modelDockerVolume/devCli`文件夹
	- 修改`config.json`文件
		- 修改database👉`satellite_database`对应值为`ard_satellite`, 添加逗号
		- 添加键值对database👉`dev_database` : `ard_dev`
	- 修改watcher.py文件
		- 替换为新的watcher.py文件(back文件夹下)
- 运行命令：
```bash
docker restart back
```



## 九、MinIO 更新

- 浏览器打开网址`http://172.31.13.21:9001`
- 添加新桶`user`
- 确保新桶的隐私策略为`public`



## 十、Titiler 更新

- 记得更新`config.json`文件为`vmod`
- 进入`172.31.13.22`节点的`/mnt/volumes/titiler`文件夹，备份全部代码文件
- 备份后在每个子文件夹下依次删除，除了`_pycache__`的文件夹
- 拷贝新的文件（除了__pycache__文件夹）到相应目录（在version2文件夹下）
- 运行命令：
```bash
docker restart $(docker ps -q)
```



## 十一、ModelServer 更新

- 大范围报错考虑的几个问题：ray上下文参数体量庞大，有历史复用机制，JSON一半传不了了，内存是针对格网而言的，应该不会爆炸，如果💥，考虑每个任务设置内存cpu上限；grid_mosaic内存显式释放
- 大范围的几个瓶颈Minio、后端、ray计算
- 复杂无云一版图可能会因为找不到NIR报错
- 注意`config`修改，涉及`ard_satellite`的，涉及日志的加上`flush=True`
- 进入`172.31.13.23`节点中的`/mnt/volumes/modelServer`文件夹，备份全部代码文件
- 备份后在每个子文件夹依次删除，除了`_pycache__`和`history`文件夹
- 拷贝新的文件（除了__pycache__文件夹和history文件夹）到相应目录（在modelServer文件夹下）
- 依次运行命令：
```bash
# 启动model-server
docker run -d --name model-server -p 5000:5000 -p 6379:6379 -p 8265:8265 -v /mnt/volumes/modelServer:/usr/resource --network=host -w /usr/resource --restart=always --privileged=true --shm-size=13gb model-server:0812 bash -c "ray start --include-dashboard=True --head --node-ip-address=0.0.0.0 --port=6379 --dashboard-host=0.0.0.0 --num-cpus=36 --memory=36000000000 --object-store-memory=12000000000 && python -m dataProcessing.server"

# 检查是否正常
docker logs model-server

# 启动工作节点1
docker run -d --name ray-worker_1 --shm-size=5.5gb --network=host -v /mnt/volumes/modelServer:/usr/resource model-server:0812 bash -c "ray start --address='172.31.13.23:6379' --block"
```

- 进入`172.31.13.20`节点执行命令：
```bash
# 启动工作节点2
docker run -d --name ray-worker_2 --shm-size=5.5gb --network=host -v /mnt/volumes/modelServer:/usr/resource model-server:0812 bash -c "ray start --address='172.31.13.23:6379' --block"

# 启动工作节点3
docker run -d --name ray-worker_3 --shm-size=5.5gb --network=host -v /mnt/volumes/modelServer:/usr/resource model-server:0812 bash -c "ray start --address='172.31.13.23:6379' --block"
```

- 打开网址查看是否正常：`http://172.31.13.23:8265`

## Base Map service

目录结构探查