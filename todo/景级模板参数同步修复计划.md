# 景级 UDF 模板参数同步修复方案

目标：让 `frontEnd/src/views/Analysis.vue` 中“发布为工具”弹窗的参数配置（以及动态分析页面右侧 panel 的表单）与默认景级模板代码一致，统一为 `expression`、`color`、`pixel_method`，避免出现“模式/缩放系数/网格数”等旧字段。

## 阶段一：发布向导（codeEditor.vue）参数 schema 对齐
- **任务**：重新梳理 `resetToolWizard` 的初始值，让景级工具默认就展示 `expression/color/pixel_method`；表达式模板默认 `'{{expression}}'`，payload 模板同步默认值。
- **任务**：在模板切换逻辑中（`handleTemplateCommand`）确保任何默认模板都会覆盖 `toolWizardForm.params`，尤其是首次打开弹窗时不再继承旧的 “mode/scale/grid”。
- **验收**：打开“发布为工具”弹窗时，即使未选择模板，也立即看到三个参数：表达式、色带、像元方法，且默认值与代码模板一致。

## 阶段二：动态分析 panel 参数渲染对齐
- **任务**：`DynamicServicePanel.vue` 当前会根据工具 meta 的 `paramsSchema` 动态渲染表单；只要阶段一写入正确 schema，此处即可自动对齐。但需验证之前缓存的工具（level=scene）是否需要迁移：
  - 方案：在 `toolRegistry.ensureLoaded` 时检测旧工具（通过参数 key 集合或 level 缺失）并提示用户重新发布，或尝试自动迁移。
  - 临时措施：若检测到旧字段（mode/scale/grid），提醒用户“请重新发布以获取最新模板”，并禁止调用，避免运行失败。
- **验收**：动态分析页面“发布的工具”点击景级工具后，右侧 panel 仅展示三个字段（expression/color/pixel_method），默认值与模板一致；若工具为旧 schema，则显示提示信息。

## 阶段三：缓存/草稿兼容策略
- **任务**：发布向导会将表单草稿存 `localStorage`。需要在加载草稿时校验其参数 schema，如果检测到旧字段则自动重置为新模板（或弹提示让用户重置）。
- **验收**：用户升级后首次打开弹窗不会继续看到旧参数；如草稿内容过旧会被清理并替换为新模板，且有提示。

## 阶段四：验证与回归
- **手动验证**：
  1. 新建景级工具，进入编辑页 → 自动填充模板 → 打开“发布为工具” → 参数显示 expression/color/pixel_method。
  2. 发布后到动态分析页面调用 → 右侧 panel 同样展示这三项，并能够带默认值运行。
  3. 针对升级前已发布的工具，验证提示策略（例如弹窗提醒重新发布）。
- **文档/提示**：在发布向导底部添加一句说明：“景级工具默认接受表达式、色带、像元方法，如需新增参数请在模板中自行扩展。”

## 影响文件
- `frontEnd/src/components/analysisComponents/codeEditor.vue`
- `frontEnd/src/components/dataCenter/thematic/DynamicServicePanel.vue`
- `frontEnd/src/store/toolRegistry.ts`（可选：旧工具 schema 迁移逻辑）
- 其他：如需为用户提示新增 UI，可在 `DynamicServicePanel` 或向导对话框中补充。

